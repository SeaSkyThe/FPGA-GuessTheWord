{% extends 'base.html' %}

<!-- ESSE BLOCO É REFERENTE AO LADO ESQUERDO DA TELA, ONDE FICA A MENSAGEM DE BOAS VINDAS-->
{% block player_profile %}
    {% if round %}
        <p>Bem vinda(o)!</p>
        <h2>{{round.player}}</h2>
        <p><br>Obrigado por jogar nosso jogo!</p>

        <button type="button" class='nes-btn' id="previous-question-button" onclick="">
            <img style="" src="https://img.icons8.com/ios-filled/30/000000/chevron-left.png"/>
        </button>
    {% else %}
        <h3>Jogador não encontrado</h3>
        <p><br>Por favor <a href="{% url 'register' %}">registre-se</a> e volte mais tarde.</p>
    {% endif %}
{% endblock player_profile %}

<!-- ESSE BLOCO É A PARTE CENTRAL, O JOGO DE FATO -->
{% block content %}
    {% comment %} TODO GAME {% endcomment %}
    {% if round %} <!-- SE O REGISTRO OCORRER COM SUCESSO E O ROUND FOI CRIADO MOSTRA O JOGO -->
        <div id="div-enunciado" class="align-items-center text-center">

        </div>
        <div id="game">

        </div>
        <script>
            // Processando questao
            var question = {} 
            var enunciado = ""
            var resposta = ""
            var dificuldade = ""
            var disciplina = ""
            var question_id = ""
            {% for question in question %} // Aqui é uma lista com apenas uma questão, para facilitar o manuseio da questao via javascript
                enunciado = "{{question.tip}}"
                resposta = "{{question.answer}}"
                dificuldade = "{{question.difficulty}}"
                disciplina = "{{question.subject}}"
                question_id = parseInt("{{question.id}}")
                question = {"tip": enunciado, "answer": resposta, "difficulty": dificuldade, "subject": disciplina, "question_id": question_id}
            {% endfor %}
            console.log(question);
            
            // Score Variables
            var score = parseInt("{{round.score}}")
            var score_area
            // Global Variables
            var current_guess = 0
            var current_letter = 0
            var number_of_guesses = 6
            var current_word = resposta.toUpperCase()
            var number_of_characters = current_word.length
            var correct_letter = 0

            // Init board
            function init(){
                // Pontuacao do user
                score_area = document.getElementById("player_score")
                
                // Enunciado aparecendo antes da questao
                enunciado = document.createElement("p")
                //enunciado.textContent = questions[0].tip
                enunciado.textContent = question.tip

                let play = document.getElementById("game")
                play.innerHTML = ""

                play.appendChild(enunciado)
                
                for(i = 0; i < number_of_guesses; i++){
                    let each_row = document.createElement("div")
                    each_row.classList.add("play-row")
                    for(j = 0; j < number_of_characters; j++){
                        let box_letter = document.createElement("div")
                        box_letter.classList.add("play-box")
                        each_row.appendChild(box_letter)
                    }
                    play.appendChild(each_row)
                }
            }
            
            window.onload = (event)=>{
                init()
            }
            
            document.addEventListener("keyup", (e) => {
                let pressed_key = String(e.key)
                if(pressed_key == "Backspace"){
                    delete_letter()
                    return
                }

                if(pressed_key == "Enter"){
                    guess_check()
                    return
                }

                let match_key = pressed_key.match(/^[a-z|A-Z]$/)
                
                if(match_key > 1 || !match_key){
                    return
                }
                else{
                    insert_letter(pressed_key)
                }
            })

            function delete_letter(){
                if(current_letter == 0){
                    return
                }
                let row = document.getElementsByClassName("play-row")[current_guess]
                let box = row.children[current_letter-1]
                box.textContent = ""
                box.classList.remove("letter-input")
                box.classList.add("play-box")
                current_letter = current_letter - 1
            }

            function guess_check(){
                if(current_letter < number_of_characters){
                    return
                }
                guess_word = ""
                for(i = 0; i < number_of_characters; i++){
                    let current_row = document.getElementsByClassName("play-row")[current_guess]
                    let box_letter = current_row.children[i]
                    let current_letter = box_letter.textContent
                    current_letter = current_letter.toUpperCase()
                    guess_word = guess_word + current_letter
                    
                    
                    if(current_letter == current_word[i]){
                        box_letter.classList.add("correct-letter")
                        correct_letter = correct_letter + 1
                    }
                    else if(current_word.indexOf(current_letter) != -1){
                        box_letter.classList.add("wrong-pos-letter")
                    }
                    else{
                        box_letter.classList.add("wrong-letter")
                    }
                }
                if(correct_letter == number_of_characters){
                    current_guess = 0
                    setTimeout(() => {
                        init();
                    }, "3000")
                }
                else{
                    current_guess = current_guess + 1
                }
                current_letter = 0
                correct_letter = 0
            }

            function insert_letter(pressed_key){
                if(current_letter >= number_of_characters || current_guess == 7){
                    return
                }
                let current_row = document.getElementsByClassName("play-row")[current_guess]
                let box_letter = current_row.children[current_letter]
                let paragraph = document.createElement("p")
                paragraph.textContent = pressed_key
                box_letter.appendChild(paragraph)
                box_letter.classList.add("letter-input")
                current_letter = current_letter + 1

            }
        </script>
    {% else %}
        <div class='register_block'>
            <div class="nes-container with-title is-centered is-dark">
                <p class='title'>Talvez você esteja pulando alguns passos querido jogador, ou um erro da nossa parte ocorreu.</p>
                <div class="nes-field">
                    <label>Por favor, indentifique-se antes de jogar</label>
                    <p></p>
                    <a class="nes-btn" href={% url 'register' %}>Pagina de registro</a>
                </div>
            </div>
        </div>
        
    {% endif %}    
    

    <script>

    </script>
{% endblock content %}

<!-- ESSE É O BLOCO À DIREITA, ONDE É MOSTRADA A PONTUAÇÃO DO PLAYER -->
{% block player_record %}
    {% if round %}
        <p class='text-right' >Questão atual: </p>
        <h2 id="current_question_text" class='text-right'>{{current_question}}</h2>
        <br>
        <p class='text-right'>Sua pontuação atual é: </p>
        <h2 id="player_score" class='text-right'>{{round.score}}</h2>
        <p class='text-right'><br>Toda vez que você erra a resposta, sua pontuação é dividida por 2, então tome cuidado! Evite chutes.</p>
        
        <button type="button" class='nes-btn' id="next-question-button">
            <img style="transform: rotate(180deg);" src="https://img.icons8.com/ios-filled/30/000000/chevron-left.png"/>
        </button>

        <script>
            current_question_text = document.getElementById("current_question_text");
            
            function replaceChar(origString, replaceChar, index){
                let firstPart = origString.slice(0, index);
                let lastPart = origString.slice(index + 1);
                let newString =
                    firstPart + replaceChar + lastPart;
                return newString;
            }

            // TRATAMENTO DO BOTAO QUE EXIBE A QUESTÃO ANTERIOR
            document.getElementById('previous-question-button').addEventListener('click', previousQuestion);
            async function previousQuestion(){
                nextQuestionNumber = parseInt(window.location.href.charAt(window.location.href.length - 2)) - 1;
                if(nextQuestionNumber < 1){
                    nextQuestionNumber = nextQuestionNumber + 1
                }  
                window.location.assign(replaceChar(window.location.href, nextQuestionNumber, -2));

            }

            // TRATAMENTO DO BOTAO QUE EXIBE A PROXIMA QUESTÃO
            document.getElementById('next-question-button').addEventListener('click', nextQuestion);
            async function nextQuestion(){
                nextQuestionNumber = parseInt(window.location.href.charAt(window.location.href.length - 2)) + 1;
                if(nextQuestionNumber > parseInt("{{number_of_questions}}")){
                    nextQuestionNumber = nextQuestionNumber - 1
                } 
                window.location.assign(replaceChar(window.location.href, nextQuestionNumber, -2));

            }
        </script>
    {% else %}
        <h3 class='text-right'>Pontuação não encontrada</h3>
        <p><br>Por favor <a href="{% url 'register' %}">registre-se</a> e volte mais tarde.</p>
    {% endif %}
{% endblock player_record %}
